<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดสรุปข้อมูล Wi-Fi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f2f5;
        }
        .chart-container {
            position: relative;
            width: 100%;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            padding: 1.5rem;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a202c;
        }
        .sub-header {
            font-size: 0.875rem;
            color: #718096;
        }
        .kpi-card {
             background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .kpi-icon {
            padding: 0.75rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">แดชบอร์ดสรุปข้อมูล Wi-Fi</h1>
                    <p class="text-gray-500 mt-1">ภาพรวมประสิทธิภาพและปัญหาของระบบ Wi-Fi ประจำเดือน</p>
                </div>
                <button class="mt-4 sm:mt-0 w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    ดาวน์โหลดรายงาน
                </button>
            </div>
             <!-- KPI Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="kpi-card">
                    <div class="kpi-icon bg-blue-100 text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Usage ทั้งหมด</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalUsage">0 GB</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon bg-green-100 text-green-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Client ทั้งหมด</p>
                        <p class="text-2xl font-bold text-gray-800" id="totalClients">0</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon bg-teal-100 text-teal-600">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Availability เฉลี่ย</p>
                        <p class="text-2xl font-bold text-gray-800" id="avgAvailabilityKpi">0%</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon bg-red-100 text-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">สาขาที่ต้องตรวจสอบ</p>
                        <p class="text-2xl font-bold text-gray-800" id="problematicBranches">0</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="flex flex-col gap-6 mt-6">
            
            <!-- Section 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                 <!-- 5 อันดับสาเหตุของปัญหา -->
                <div class="card">
                    <h2 class="header-title">5 อันดับสาเหตุของปัญหา (Top 5 Problem Causes)</h2>
                    <p class="sub-header">สาเหตุหลักที่ทำให้ Wi-Fi ไม่สามารถใช้งานได้</p>
                    <div class="mt-4 chart-container" style="height: 350px;">
                        <canvas id="causeCodeChart"></canvas>
                    </div>
                </div>
                <!-- จำนวน Fault Wi-Fi แบ่งตาม Zone -->
                <div class="card">
                    <h2 class="header-title">จำนวน Fault Wi-Fi ตามโซน</h2>
                    <p class="sub-header">สัดส่วนปัญหาที่เกิดขึ้นในแต่ละพื้นที่</p>
                    <div class="mt-4 chart-container" style="height: 350px;">
                        <canvas id="faultZoneChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Section 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- สัดส่วนผู้ใช้งาน (Client) ตามภาค -->
                <div class="card">
                    <h3 class="header-title text-center">สัดส่วนผู้ใช้งาน (Client) ตามภาค</h3>
                    <div class="chart-container mt-2" style="height: 350px;">
                        <canvas id="regionClientChart"></canvas>
                    </div>
                </div>
                <!-- 10 อันดับจังหวัดตามปริมาณใช้งาน (Usage) -->
                <div class="card">
                    <h3 class="header-title text-center">10 อันดับจังหวัดตามปริมาณใช้งาน (Usage)</h3>
                    <div class="chart-container mt-2" style="height: 350px;">
                        <canvas id="provinceUsageChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Section 3: New Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <!-- สัดส่วนผู้ใช้งาน (Client) ตามจังหวัด -->
                  <div class="card">
                      <h3 class="header-title text-center">สัดส่วนผู้ใช้งาน (Client) ตามจังหวัด (Top 7)</h3>
                      <div class="chart-container mt-2" style="height: 350px;">
                          <canvas id="provinceClientChart"></canvas>
                      </div>
                  </div>
                  <!-- อันดับภาคตามปริมาณใช้งาน (Usage) -->
                  <div class="card">
                      <h3 class="header-title text-center">อันดับภาคตามปริมาณใช้งาน (Usage)</h3>
                      <div class="chart-container mt-2" style="height: 350px;">
                          <canvas id="regionUsageChart"></canvas>
                      </div>
                  </div>
            </div>

            <!-- Section 4 -->
            <div class="card">
                <h2 class="header-title">สรุปข้อมูลการใช้งานรายสาขา</h2>
                <p class="sub-header">20 อันดับแรกตามปริมาณการใช้งานและจำนวนผู้ใช้</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-12 mt-4">
                    <div>
                        <h3 class="font-bold text-center text-gray-700">ปริมาณการใช้งาน (Usage)</h3>
                        <div class="chart-container mt-2" style="height: 450px;">
                            <canvas id="topUsageChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-center text-gray-700">จำนวนผู้ใช้ (Client)</h3>
                        <div class="chart-container mt-2" style="height: 450px;">
                            <canvas id="topUsersChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 5: Lowest Availability -->
            <div class="card">
                <h2 class="header-title text-center">10 อันดับสาขาที่ Availability ต่ำที่สุด</h2>
                <div class="chart-container mt-2" style="height: 350px;">
                    <canvas id="lowestAvailabilityChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Professional Color Palette ---
            const professionalColors = ['#36A2EB', '#4BC0C0', '#FFCD56', '#FF9F40', '#9966FF', '#C9CBCF', '#FF6384', '#A9A9A9'];
            const primaryColor = 'rgba(54, 162, 235, 0.8)'; // Blue
            const primaryBorderColor = 'rgba(54, 162, 235, 1)';
            const secondaryColor = 'rgba(75, 192, 192, 0.8)'; // Teal
            const secondaryBorderColor = 'rgba(75, 192, 192, 1)';
            const accentColor = 'rgba(255, 159, 64, 0.8)'; // Orange
            const accentBorderColor = 'rgba(255, 159, 64, 1)';
            const dangerColor = 'rgba(255, 99, 132, 0.8)'; // Red
            const dangerBorderColor = 'rgba(255, 99, 132, 1)';

            // --- Chart.js Global Configuration ---
            Chart.defaults.font.family = "'Sarabun', sans-serif";
            Chart.register(ChartDataLabels);

            // --- Data Section ---
            const faultZoneData = [
                { zone: 'กรุงเทพและปริมณฑล', faults: 120 },
                { zone: 'ภาคเหนือ', faults: 55 },
                { zone: 'ภาคตะวันออกเฉียงเหนือ', faults: 80 },
                { zone: 'ภาคกลาง', faults: 60 },
                { zone: 'ภาคตะวันออก', faults: 45 },
                { zone: 'ภาคใต้', faults: 70 }
            ];

            function parseData() {
                const csvData = `uptime(min)	Down Time	Availability	Date	Site	จังหวัด	ภาค	Usage (Gigabytes)	Client	CAUSECODE_DESCRIPTION	WORKCODE_DESCRIPTION
5760	2522	69.55%	2025-08-01 16:25	7-11 บ้านแม่แรม (อ.แม่ริม) (8614)	เชียงใหม่	ภาคเหนือ	18.37	96	WIFI - Access Point	Replaced
24462	1585	93.91%	2025-08-02 13:25	7-11 ปตท.พีเอสวาย ท่าพระ (6206)	ขอนแก่น	ภาคตะวันออกเฉียงเหนือ	17.81	185	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
24399	85	99.65%	2025-08-03 15:10	7-11 แยกปากร่วมบ่อวิน (ชลบุรี) (19412)	ชลบุรี	ภาคตะวันออก	16.54	257	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
1438	1387	50.90%	2025-08-10 13:25	7-11 หนองปลาไหลปลวกแดง(ระยอง) (22410)	ระยอง	ภาคตะวันออก	13.66	73	WIFI - Access Point	Remote Reset/Re-Configured
10505	10	99.90%	2025-08-10 13:25	7-11 ชุมชนนวมินทร์(นครสวรรค์) (005484)	นครสวรรค์	ภาคกลาง	12.86	112	optic	Close Ticket
102674	2923	97.23%	2025-08-23 10:40	7-11 หนองประทีป (2299)	เชียงใหม่	ภาคเหนือ	12.77	94	WIFI - RJ-45 Connector/LAN Cable	Replaced
4517	1372	76.70%	2025-08-16 13:26	7-11 พหลโยธินท่าศาลา (ลพบุรี) (9539)	ลพบุรี	ภาคกลาง	12.29	98	WIFI - Remote Recovery by NOC	Remote Reset/Re-Configured
15911	24	99.85%	2025-08-09 14:11	7-11 ร้านค้าสวัสดิการฐานทัพเรือสัตหีบ (22910)	ชลบุรี	ภาคตะวันออก	12.19	65	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
14628	1120	92.89%	2025-08-02 13:25	7-11 เวียงทอง (8633)	แพร่	ภาคเหนือ	11.38	92	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
23040	1545	93.72%	2025-08-03 13:25	7-11 PTTOR พระราม 4-พระโขนง (18527)	กรุงเทพมหานคร	ภาคกลาง	9.89	135	WIFI - Power System	Turn on Breaker
25882	160	99.39%	2025-08-02 13:25	7-11 ประตูน้ำพระอินทร์ ซอย 8 (4040)	พระนครศรีอยุธยา	ภาคกลาง	9.73	167	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
15831	980	94.17%	2025-08-04 16:25	7-11 วงเวียนรถไฟศรีสะเกษ (4881)	#VALUE!	#VALUE!	9.1	175	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
11811	2973	79.89%	2025-08-10 9:18	7-11 ปตท.ดอกคำใต้ 2 (13686)	พะเยา	ภาคเหนือ	9.05	59	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
3960	846	82.40%	2025-08-14 8:25	7-11 มอ.สงขลา (หอพักชาย ) (9577)	สงขลา	ภาคใต้	8.74	127	WIFI - Modem GPON/4G/5G/Other	Reset/Reload/Reboot
945	6220	13.19%	2025-08-15 16:30	7-11 ตลาด เอ.ซี.สายไหม (6011)	กรุงเทพมหานคร	ภาคกลาง	7.92	619	WIFI - Dropwire Cable	Replaced
7891	4210	65.21%	2025-08-12 15:55	7-11 Sony Canteen 1 (ชลบุรี) (22852)	ชลบุรี	ภาคตะวันออก	7.91	120	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
3216	2875	52.80%	2025-08-03 13:25	7-11 ชุมชนหนองน้ำส้ม 2 (6422)	พระนครศรีอยุธยา	ภาคกลาง	7.6	107	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
2854	331	89.61%	2025-08-07 12:06	7-11 พหลโยธิน 15 จุด 2 (5843)	กรุงเทพมหานคร	ภาคกลาง	7.47	149	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
1986	342	85.31%	2025-08-06 13:23	7-11 ท่าข้าม 10 (6703)	กรุงเทพมหานคร	ภาคกลาง	7.3	165	WIFI - Dropwire Cable	Permanence Respliced
3720	381	90.71%	2025-08-15 16:01	7-11 ก.ม. 25 (647)	กรุงเทพมหานคร	ภาคกลาง	7.21	132	ข้อต่อหลวม ไม่ดี/ไม่สนิท	Close Ticket
24480	55	99.78%	2025-08-03 14:25	7-11 ปตท.เหนือคลอง (4761)	กระบี่	ภาคใต้	7.17	175	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
25920	2350	91.69%	2025-08-02 19:50	7-11 ปตท.เกรียงศักดิ์ยโสธร (10178)	#VALUE!	#VALUE!	7.11	84	WIFI - Customer	Resolved by Site Owner
12914	1640	88.73%	2025-08-10 13:25	7-11 หน้าลือคำหาญ (1582)	อุบลราชธานี	ภาคตะวันออกเฉียงเหนือ	6.58	122	WIFI - Modem GPON/4G/5G/Other	Re-Plug
21891	1435	93.85%	2025-08-03 13:25	7-11 แยกเรือนแพ (5074)	พิษณุโลก	ภาคกลาง	6.56	93	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
17348	1495	92.07%	2025-08-07 13:25	7-11 ท่าลาน 2 (6825)	สระบุรี	ภาคกลาง	6.53	48	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
8446	1480	85.09%	2025-08-23 10:40	7-11 PTTOR ลำลูกกาคลอง 3 (16214)	ปทุมธานี	ภาคกลาง	6.33	296	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
20035	2378	89.39%	2025-08-04 16:26	7-11 บายพาสหนองคาย (10616)	หนองคาย	ภาคตะวันออกเฉียงเหนือ	6.22	92	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
8876	1440	86.04%	2025-08-09 14:40	7-11 บ้านศรีดอนไชย 1 (5094)	เชียงใหม่	ภาคเหนือ	5.49	87	Fiber optic cut - Accident	Permanence Respliced
8770	6107	58.95%	2025-08-12 11:09	7-11 สุภาพงษ์ 1 แยก 3 (13643)	กรุงเทพมหานคร	ภาคกลาง	5.36	216	WIFI - Access Point	Replaced
94	7180	1.29%	2025-08-11 13:25	7-11 ธวัชดินแดง (10843)	ร้อยเอ็ด	ภาคตะวันออกเฉียงเหนือ	5.06	65	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
742	1539	32.53%	2025-08-14 13:26	7-11 ปตท.ศรีเมืองใหม่ (13378)	อุบลราชธานี	ภาคตะวันออกเฉียงเหนือ	4.87	167	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
728	1180	38.16%	2025-08-06 13:25	7-11 ธาดาทาว์นเคิร์ฟ-เขาขยาย (ชลบุรี) (16851)	ชลบุรี	ภาคตะวันออก	4.84	80	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
10035	1257	88.87%	2025-08-07 13:47	7-11 ตลาดเพชรเกษม 77 (5981)	กรุงเทพมหานคร	ภาคกลาง	4.77	152	WIFI - Modem GPON/4G/5G/Other	Recovery by itself
17486	955	94.82%	2025-08-24 16:11	7-11 PTTOR ศรีสาคร (18009)	นราธิวาส	ภาคใต้	4.74	94	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
2098	1375	60.41%	2025-08-04 13:25	7-11 ปตท.พระธาตุเรณู (11087)	นครพนม	ภาคตะวันออกเฉียงเหนือ	4.73	112	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
24334	1060	95.83%	2025-08-03 14:40	7-11 บ้านป่าแดง (อ.ไชยปราการ) (18858)	เชียงใหม่	ภาคเหนือ	4.58	65	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
7142	1361	83.99%	2025-08-03 9:24	7-11 รพ.ชัยนาท (1933)	ชัยนาท	ภาคกลาง	4.56	99	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
25709	5344	82.79%	2025-08-02 19:03	7-11 ประชาราษฎร์บำเพ็ญ 18 (19233)	กรุงเทพมหานคร	ภาคกลาง	4.51	278	WIFI - Access Point	Recovery by itself
2823	1337	67.86%	2025-08-04 16:10	7-11 รามอินทรา กม.4/2 (1009)	กรุงเทพมหานคร	ภาคกลาง	4.33	240	WIFI - RJ-45 Connector/LAN Cable	Cleaned up
163954	2507	98.49%	2025-08-23 16:25	7-11 ตลาดแม่ระมาด (5133)	ตาก	ภาคตะวันตก	4.3	104	WIFI - Access Point	Reset/Reload/Reboot
33810	5687	85.60%	2025-08-15 16:01	7-11 อนามัยท่าข้าม (18443)	กรุงเทพมหานคร	ภาคกลาง	4.25	70	WIFI - Connector/Jumper/SFP/Patch Cord	Replaced
27900	130	99.54%	2025-08-21 13:25	7-11 PTTOR ชนะชัยไร่น้อย (14559)	อุบลราชธานี	ภาคตะวันออกเฉียงเหนือ	4.25	108	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
2023	232	89.71%	2025-08-13 8:25	7-11 ชุมชนสัมปทวน (นครชัยศรี) (22473)	นครปฐม	ภาคกลาง	4.06	32	WIFI - Modem GPON/4G/5G/Other	Reset/Reload/Reboot
8368	1045	88.90%	2025-08-04 14:40	7-11 ริมห้วยวังนอง (17965)	อุบลราชธานี	ภาคตะวันออกเฉียงเหนือ	4	54	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
1	1316	0.08%	2025-08-02 10:09	7-11 ศูนย์วิจัยประสาท (11038)	กรุงเทพมหานคร	ภาคกลาง	3.92	253	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
17096	3196	84.25%	2025-08-06 13:25	7-11 PTTOR พระราม 2 กม. 9 (16787)	กรุงเทพมหานคร	ภาคกลาง	3.64	171	WIFI - Access Point	Replaced
17096	3196	84.25%	2025-08-06 13:25	7-11 PTTOR พระราม 2 กม. 9 (16787)	กรุงเทพมหานคร	ภาคกลาง	3.64	171	WIFI - Access Point	Replaced
51909	1539	97.12%	2025-08-24 13:26	7-11 พระราชวังบางปะอิน (749)	พระนครศรีอยุธยา	ภาคกลาง	3.63	184	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
61920	287	99.54%	2025-08-24 13:26	7-11 เบญจมิตร (1732)	กรุงเทพมหานคร	ภาคกลาง	3.6	153	Hardware Faulty - Splitter L2	Disconnected
12905	271	97.94%	2025-08-11 12:10	7-11 ชุมชนบ้านนาเดิม (14235)	สุราษฎร์ธานี	ภาคใต้	3.57	110	WIFI - Access Point	Re-Configured
22340	2878	88.59%	2025-08-01 10:01	7-11 นวมินทร์ ซ.3(เอแบคบางนา) (12066)	#SPILL!	#SPILL!	3.53	109	WIFI - Other	Renovated
8978	1122	88.89%	2025-08-13 15:41	7-11 พระราม 2 บางกระดี่ (14524)	กรุงเทพมหานคร	ภาคกลาง	3.49	207	WIFI - Access Point	Replaced
18823	925	95.32%	2025-08-05 16:40	7-11 PTTOR ราชพฤกษ์-สาทร (15576)	กรุงเทพมหานคร	ภาคกลาง	3.46	194	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
18823	925	95.32%	2025-08-05 16:40	7-11 PTTOR ราชพฤกษ์-สาทร (15576)	กรุงเทพมหานคร	ภาคกลาง	3.46	194	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
17614	1390	92.69%	2025-08-02 13:25	7-11 ชุมชนศรีเพชรการเคหะ (15477)	สมุทรปราการ	ภาคกลาง	3.42	69	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
5717	159	97.29%	2025-08-16 13:26	7-11 331 โป่งสะเก็ด (11408)	ชลบุรี	ภาคตะวันออก	3.41	85	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
18415	1135	94.19%	2025-08-07 13:25	7-11 บุญอยู่ (1112)	กรุงเทพมหานคร	ภาคกลาง	3.22	348	No identified root cause	Incident not resolved within 24 hrs of alarm clearance
1515	3012	33.47%	2025-08-05 13:25	7-11 บ้านหนองบัว (อ.ฝาง) (14121)	เชียงใหม่	ภาคเหนือ	3.18	79	WIFI - RJ-45 Connector/LAN Cable	Cleaned up
18022	3025	85.63%	2025-08-02 10:25	7-11 LPN รัชดาท่าพระ (9773)	กรุงเทพมหานคร	ภาคกลาง	3.17	58	WIFI - Access Point	Reset/Reload/Reboot
17384	1440	92.35%	2025-08-06 13:04	7-11 PTTOR ราชภัฏสกลนคร (16087)	สกลนคร	ภาคตะวันออกเฉียงเหนือ	3.16	225	เสีย (เปลี่ยนใหม่/ตัดต่อใหม่)	เปลี่ยนใหม่/ตัดต่อใหม่
902	1268	41.57%	2025-08-21 13:25	7-11 แยกวัดศรีศรัทธาธรรม (19504)	สมุทรสงคราม	ภาคกลาง	3.12	84	WIFI - Access Point	Reset/Reload/Reboot`;

                const lines = csvData.trim().split('\n');
                const header = lines.shift(); // remove header
                
                const allBranchesData = lines.map(line => {
                    const columns = line.split('\t');
                    if (columns.length < 11) return null; 

                    return {
                        name: columns[4],
                        province: columns[5],
                        region: columns[6],
                        usage: parseFloat(columns[7]),
                        client: parseInt(columns[8], 10),
                        date: columns[3].split(' ')[0], // Get only YYYY-MM-DD
                        availability: parseFloat(columns[2].replace('%', '')),
                        cause: columns[9] ? columns[9].trim() : 'ไม่ระบุ'
                    };
                }).filter(b => 
                    b && 
                    b.province && 
                    b.region && 
                    b.province !== '#VALUE!' && 
                    b.region !== '#VALUE!' && 
                    b.province !== '#SPILL!' && 
                    b.region !== '#SPILL!' &&
                    !isNaN(b.availability) &&
                    !isNaN(b.usage) &&
                    !isNaN(b.client)
                );
                
                return allBranchesData;
            }

            async function renderDashboard() {
                const allBranchesData = await parseData();
                
                // --- Data Aggregation and Sorting ---
                // KPIs
                const totalUsage = allBranchesData.reduce((sum, b) => sum + b.usage, 0);
                const totalClients = allBranchesData.reduce((sum, b) => sum + b.client, 0);
                const problematicBranches = allBranchesData.filter(b => b.availability < 95).length;
                const avgAvailability = allBranchesData.length > 0 ? (allBranchesData.reduce((sum, b) => sum + b.availability, 0) / allBranchesData.length) : 0;
                
                document.getElementById('totalUsage').textContent = `${totalUsage.toFixed(2)} GB`;
                document.getElementById('totalClients').textContent = totalClients.toLocaleString();
                document.getElementById('avgAvailabilityKpi').textContent = `${avgAvailability.toFixed(2)}%`;
                document.getElementById('problematicBranches').textContent = problematicBranches;


                // Fault Zones for Chart
                const faultZones = faultZoneData.map(d => d.zone);
                const faultData = faultZoneData.map(d => d.faults);

                // Availability Data
                const availabilityRawData = allBranchesData.map(d => ({ date: d.date, percent: d.availability }));
                availabilityRawData.sort((a, b) => new Date(a.date) - new Date(b.date));
                const daysInMonth = availabilityRawData.map(d => new Date(d.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }));
                const availabilityData = availabilityRawData.map(d => d.percent > 100 ? 100 : d.percent); // Cap data at 100
                
                // Top 20 Usage
                const sortedByUsage = [...allBranchesData].sort((a, b) => b.usage - a.usage).slice(0, 20);
                const top20UsageData = {
                    labels: sortedByUsage.map(b => b.name),
                    data: sortedByUsage.map(b => b.usage)
                };
                // Top 20 Clients
                const sortedByClient = [...allBranchesData].sort((a, b) => b.client - a.client).slice(0, 20);
                const top20ClientData = {
                    labels: sortedByClient.map(b => b.name),
                    data: sortedByClient.map(b => b.client)
                };
                // Region Summary
                const regionSummary = allBranchesData.reduce((acc, branch) => {
                    const region = branch.region;
                    if (region) {
                        if (!acc[region]) {
                            acc[region] = { client: 0, usage: 0 };
                        }
                        acc[region].client += branch.client;
                        acc[region].usage += branch.usage;
                    }
                    return acc;
                }, {});
                // Province Summary
                const provinceSummary = allBranchesData.reduce((acc, branch) => {
                    const province = branch.province;
                    if (province) {
                        if (!acc[province]) {
                            acc[province] = { client: 0, usage: 0 };
                        }
                        acc[province].client += branch.client;
                        acc[province].usage += branch.usage;
                    }
                    return acc;
                }, {});

                // Cause Code Summary
                const causeCodeSummary = allBranchesData.reduce((acc, branch) => {
                    const cause = branch.cause;
                    if (cause) {
                        acc[cause] = (acc[cause] || 0) + 1;
                    }
                    return acc;
                }, {});

                const sortedCauses = Object.entries(causeCodeSummary).sort(([,a],[,b]) => b - a).slice(0, 5);
                const causeCodeLabels = sortedCauses.map(c => c[0]);
                const causeCodeData = sortedCauses.map(c => c[1]);

                
                // --- Chart Rendering ---
                let charts = {};
                function renderChart(canvasId, config) {
                    if (charts[canvasId]) {
                        charts[canvasId].destroy();
                    }
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    charts[canvasId] = new Chart(ctx, config);
                }

                renderChart('causeCodeChart', {
                     type: 'bar',
                    data: {
                        labels: causeCodeLabels,
                        datasets: [{
                            label: 'จำนวนครั้ง',
                            data: causeCodeData,
                            backgroundColor: professionalColors,
                            borderColor: professionalColors.map(c => c.replace('0.8', '1')),
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: { display: true, text: 'จำนวนครั้งที่เกิดปัญหา' }
                            }
                        }
                    }
                });

                renderChart('faultZoneChart', {
                    type: 'doughnut',
                    data: {
                        labels: faultZones,
                        datasets: [{
                            label: 'จำนวน Faults',
                            data: faultData,
                            backgroundColor: professionalColors,
                            hoverOffset: 4,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                renderChart('topUsageChart', {
                    type: 'bar',
                    data: {
                        labels: top20UsageData.labels,
                        datasets: [{
                            label: 'Usage (GB)',
                            data: top20UsageData.data,
                            backgroundColor: primaryColor,
                            borderColor: primaryBorderColor,
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: { display: true, text: 'Usage (GB)' }
                            }
                        }
                    }
                });

                renderChart('topUsersChart', {
                    type: 'bar',
                    data: {
                        labels: top20ClientData.labels,
                        datasets: [{
                            label: 'จำนวน Client',
                            data: top20ClientData.data,
                            backgroundColor: secondaryColor,
                            borderColor: secondaryBorderColor,
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: { display: true, text: 'จำนวน Client' }
                            }
                        }
                    }
                });
                
                const regionLabels = Object.keys(regionSummary);
                const regionClientData = regionLabels.map(region => regionSummary[region].client);
                renderChart('regionClientChart', {
                    type: 'pie',
                    data: {
                        labels: regionLabels,
                        datasets: [{
                            label: 'จำนวน Client',
                            data: regionClientData,
                            backgroundColor: professionalColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = 0;
                                    let dataArr = ctx.chart.data.datasets[0].data;
                                    dataArr.map(data => {
                                        sum += data;
                                    });
                                    let percentage = (value*100 / sum).toFixed(2)+"%";
                                    return percentage;
                                },
                                color: '#fff',
                            }
                        }
                    }
                });

                const sortedProvinces = Object.entries(provinceSummary).sort(([,a],[,b]) => b.usage - a.usage).slice(0, 10);
                const provinceLabels = sortedProvinces.map(p => p[0]);
                const provinceUsageData = sortedProvinces.map(p => p[1].usage.toFixed(2));
                renderChart('provinceUsageChart', {
                    type: 'bar',
                    data: {
                        labels: provinceLabels,
                        datasets: [{
                            label: 'Usage (GB)',
                            data: provinceUsageData,
                            backgroundColor: accentColor,
                            borderColor: accentBorderColor,
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true, title: { display: true, text: 'Usage (GB)' } } }
                    }
                });

                const sortedProvincesByClient = Object.entries(provinceSummary).sort(([,a],[,b]) => b.client - a.client);
                const top7Provinces = sortedProvincesByClient.slice(0, 7);
                const otherProvincesClient = sortedProvincesByClient.slice(7).reduce((sum, current) => sum + current[1].client, 0);
                const provinceClientLabels = top7Provinces.map(p => p[0]);
                const provinceClientData = top7Provinces.map(p => p[1].client);
                if (otherProvincesClient > 0) {
                    provinceClientLabels.push('อื่น ๆ');
                    provinceClientData.push(otherProvincesClient);
                }
                renderChart('provinceClientChart', {
                    type: 'pie',
                    data: {
                        labels: provinceClientLabels,
                        datasets: [{
                            label: 'จำนวน Client',
                            data: provinceClientData,
                            backgroundColor: professionalColors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            datalabels: {
                                formatter: (value, ctx) => {
                                    let sum = 0;
                                    let dataArr = ctx.chart.data.datasets[0].data;
                                    dataArr.map(data => {
                                        sum += data;
                                    });
                                    let percentage = (value*100 / sum).toFixed(2)+"%";
                                    return percentage;
                                },
                                color: '#fff',
                            }
                        }
                    }
                });

                const sortedRegionsByUsage = Object.entries(regionSummary).sort(([,a],[,b]) => b.usage - a.usage);
                const regionUsageLabels = sortedRegionsByUsage.map(r => r[0]);
                const regionUsageData = sortedRegionsByUsage.map(r => r[1].usage.toFixed(2));
                renderChart('regionUsageChart', {
                    type: 'bar',
                    data: {
                        labels: regionUsageLabels,
                        datasets: [{
                            label: 'Usage (GB)',
                            data: regionUsageData,
                            backgroundColor: primaryColor,
                            borderColor: primaryBorderColor,
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true, title: { display: true, text: 'Usage (GB)' } } }
                    }
                });

                // --- New Chart: Lowest Availability ---
                const sortedByLowestAvailability = [...allBranchesData]
                    .sort((a, b) => a.availability - b.availability) // Ascending sort
                    .slice(0, 10);

                const lowestAvailabilityLabels = sortedByLowestAvailability.map(b => b.name);
                const lowestAvailabilityData = sortedByLowestAvailability.map(b => b.availability);

                renderChart('lowestAvailabilityChart', {
                    type: 'bar',
                    data: {
                        labels: lowestAvailabilityLabels,
                        datasets: [{
                            label: 'Availability (%)',
                            data: lowestAvailabilityData,
                            backgroundColor: dangerColor,
                            borderColor: dangerBorderColor,
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: { display: true, text: 'Availability (%)' }
                            }
                        }
                    }
                });
            }

            renderDashboard();
        });

    </script>
</body>
</html>
