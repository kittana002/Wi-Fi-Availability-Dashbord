<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ดสรุปข้อมูล Wi-Fi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f2f5;
        }
        .chart-container {
            position: relative;
            width: 100%;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            padding: 1.5rem;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a202c;
        }
        .sub-header {
            font-size: 0.875rem;
            color: #718096;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
              <div>
                  <h1 class="text-3xl font-bold text-gray-800">แดชบอร์ดสรุปข้อมูล Wi-Fi</h1>
                  <p class="text-gray-500 mt-1">ภาพรวมประสิทธิภาพและปัญหาของระบบ Wi-Fi ประจำเดือน</p>
              </div>
              <button class="mt-4 sm:mt-0 w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                  ดาวน์โหลดรายงานฉบับเต็ม
              </button>
        </header>

        <!-- Main Layout -->
        <div class="flex flex-col gap-6">
            
            <!-- Section 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Wi-Fi Availability (รายเดือน) -->
                <div class="card">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="header-title">Wi-Fi Availability (รายเดือน)</h2>
                            <p class="sub-header">เปอร์เซ็นต์ความพร้อมใช้งานของสัญญาณ Wi-Fi</p>
                        </div>
                        <div class="text-right">
                             <p class="text-3xl font-bold text-teal-600" id="avgAvailability">0%</p>
                             <p class="text-sm text-gray-500">เฉลี่ยเดือนนี้</p>
                        </div>
                    </div>
                    <div class="mt-4 chart-container" style="height: 350px;">
                        <canvas id="availabilityChart"></canvas>
                    </div>
                </div>
                <!-- จำนวน Fault Wi-Fi แบ่งตาม Zone -->
                <div class="card">
                    <h2 class="header-title">จำนวน Fault Wi-Fi ตามโซน</h2>
                    <p class="sub-header">สัดส่วนปัญหาที่เกิดขึ้นในแต่ละพื้นที่</p>
                    <div class="mt-4 chart-container" style="height: 350px;">
                        <canvas id="faultZoneChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Section 2 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- สัดส่วนผู้ใช้งาน (Client) ตามภาค -->
                <div class="card">
                    <h3 class="header-title text-center">สัดส่วนผู้ใช้งาน (Client) ตามภาค</h3>
                    <div class="chart-container mt-2" style="height: 350px;">
                        <canvas id="regionClientChart"></canvas>
                    </div>
                </div>
                <!-- 10 อันดับจังหวัดตามปริมาณใช้งาน (Usage) -->
                <div class="card">
                    <h3 class="header-title text-center">10 อันดับจังหวัดตามปริมาณใช้งาน (Usage)</h3>
                    <div class="chart-container mt-2" style="height: 350px;">
                        <canvas id="provinceUsageChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Section 3: New Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <!-- สัดส่วนผู้ใช้งาน (Client) ตามจังหวัด -->
                  <div class="card">
                      <h3 class="header-title text-center">สัดส่วนผู้ใช้งาน (Client) ตามจังหวัด (Top 7)</h3>
                      <div class="chart-container mt-2" style="height: 350px;">
                          <canvas id="provinceClientChart"></canvas>
                      </div>
                  </div>
                  <!-- อันดับภาคตามปริมาณใช้งาน (Usage) -->
                  <div class="card">
                      <h3 class="header-title text-center">อันดับภาคตามปริมาณใช้งาน (Usage)</h3>
                      <div class="chart-container mt-2" style="height: 350px;">
                          <canvas id="regionUsageChart"></canvas>
                      </div>
                  </div>
            </div>

            <!-- Section 4 -->
            <div class="card">
                <h2 class="header-title">สรุปข้อมูลการใช้งานรายสาขา</h2>
                <p class="sub-header">20 อันดับแรกตามปริมาณการใช้งานและจำนวนผู้ใช้</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-12 mt-4">
                    <div>
                        <h3 class="font-bold text-center text-gray-700">ปริมาณการใช้งาน (Usage)</h3>
                        <div class="chart-container mt-2" style="height: 450px;">
                            <canvas id="topUsageChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-center text-gray-700">จำนวนผู้ใช้ (Client)</h3>
                        <div class="chart-container mt-2" style="height: 450px;">
                            <canvas id="topUsersChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 5: Lowest Availability -->
            <div class="card">
                <h2 class="header-title text-center">10 อันดับสาขาที่ Availability ต่ำที่สุด</h2>
                <div class="chart-container mt-2" style="height: 350px;">
                    <canvas id="lowestAvailabilityChart"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Professional Color Palette ---
        const professionalColors = ['#36A2EB', '#4BC0C0', '#FFCD56', '#FF9F40', '#9966FF', '#C9CBCF', '#FF6384', '#A9A9A9'];
        const primaryColor = 'rgba(54, 162, 235, 0.8)'; // Blue
        const primaryBorderColor = 'rgba(54, 162, 235, 1)';
        const secondaryColor = 'rgba(75, 192, 192, 0.8)'; // Teal
        const secondaryBorderColor = 'rgba(75, 192, 192, 1)';
        const accentColor = 'rgba(255, 159, 64, 0.8)'; // Orange
        const accentBorderColor = 'rgba(255, 159, 64, 1)';
        const dangerColor = 'rgba(255, 99, 132, 0.8)'; // Red
        const dangerBorderColor = 'rgba(255, 99, 132, 1)';

        // ---------------------------
        // DATA SECTION (แก้ไขง่าย)
        // ---------------------------
        // 1. Fault Zones (แบ่งตามโซน)
        const faultZoneData = [
            { zone: 'กรุงเทพและปริมณฑล', faults: 120 },
            { zone: 'ภาคเหนือ', faults: 55 },
            { zone: 'ภาคตะวันออกเฉียงเหนือ', faults: 80 },
            { zone: 'ภาคกลาง', faults: 60 },
            { zone: 'ภาคตะวันออก', faults: 45 },
            { zone: 'ภาคใต้', faults: 70 }
        ];

        // 2. Branches Data (ข้อมูลสาขา)
        // ข้อมูลใหม่จากไฟล์ CSV
        const allBranchesData = [
            { name: '7-11 บ้านแม่แรม (อ.แม่ริม) (8614)', province: 'เชียงใหม่', region: 'ภาคเหนือ', usage: 18.37, client: 96, date: '2025-08-01', availability: 69.55 },
            { name: '7-11 ปตท.พีเอสวาย ท่าพระ (6206)', province: 'ขอนแก่น', region: 'ภาคตะวันออกเฉียงเหนือ', usage: 17.81, client: 185, date: '2025-08-02', availability: 93.91 },
            { name: '7-11 แยกปากร่วมบ่อวิน (ชลบุรี) (19412)', province: 'ชลบุรี', region: 'ภาคตะวันออก', usage: 16.54, client: 257, date: '2025-08-03', availability: 99.65 },
            { name: '7-11 หนองปลาไหลปลวกแดง(ระยอง) (22410)', province: 'ระยอง', region: 'ภาคตะวันออก', usage: 13.66, client: 73, date: '2025-08-10', availability: 50.9 },
            { name: '7-11 ชุมชนนวมินทร์(นครสวรรค์) (005484)', province: 'นครสวรรค์', region: 'ภาคเหนือ', usage: 12.02, client: 147, date: '2025-08-10', availability: 99.9 },
            { name: '7-11 PTT Station ปตท.อดิศรธุรกิจ (19750)', province: 'สระบุรี', region: 'ภาคกลาง', usage: 11.45, client: 123, date: '2025-08-11', availability: 99.98 },
            { name: '7-11 PTT Station ปตท.สหกรณ์การเกษตรย่านตาขาว (19747)', province: 'ตรัง', region: 'ภาคใต้', usage: 10.97, client: 104, date: '2025-08-12', availability: 99.97 },
            { name: '7-11 PTT Station ปตท.บจก.ทรัพย์ไพบูลย์ปิโตรเลียม (20188)', province: 'สุราษฎร์ธานี', region: 'ภาคใต้', usage: 10.74, client: 153, date: '2025-08-13', availability: 99.99 },
            { name: '7-11 PTT Station ปตท.บจก.โคกสูงปิโตรเลียม (20025)', province: 'สระแก้ว', region: 'ภาคตะวันออก', usage: 10.21, client: 134, date: '2025-08-14', availability: 99.95 },
            { name: '7-11 ตลาดสดบ้านบึง (ชลบุรี) (19448)', province: 'ชลบุรี', region: 'ภาคตะวันออก', usage: 9.91, client: 140, date: '2025-08-15', availability: 99.89 },
            { name: '7-11 PTT Station ปตท.บจก.พงษ์กิตติออยล์ (19749)', province: 'ชัยภูมิ', region: 'ภาคตะวันออกเฉียงเหนือ', usage: 9.8, client: 133, date: '2025-08-16', availability: 99.99 },
            { name: '7-11 PTT Station บจก.ทวีผลออยล์ (20015)', province: 'นครราชสีมา', region: 'ภาคตะวันออกเฉียงเหนือ', usage: 9.61, client: 143, date: '2025-08-17', availability: 99.99 },
            { name: '7-11 PTT Station ปตท.บจก.เจริญผลออยล์ (19803)', province: 'นครราชสีมา', region: 'ภาคตะวันออกเฉียงเหนือ', usage: 9.49, client: 125, date: '2025-08-18', availability: 99.99 },
            { name: '7-11 PTT Station ปตท.บจก.เอ็ม.พี.ปิโตรเลียม (20016)', province: 'นครราชสีมา', region: 'ภาคตะวันออกเฉียงเหนือ', usage: 9.42, client: 120, date: '2025-08-19', availability: 99.99 },
            { name: '7-11 PTT Station ปตท.บจก.หลักเมืองออยล์ (19804)', province: 'นครราชสีมา', region: 'ภาคตะวันออกเฉียงเหนือ', usage: 9.17, client: 116, date: '2025-08-20', availability: 99.99 },
            { name: '7-11 PTT Station บจก.ปิโตรเลียมเซอร์วิส (19778)', province: 'นครศรีธรรมราช', region: 'ภาคใต้', usage: 8.89, client: 111, date: '2025-08-21', availability: 99.99 },
            { name: '7-11 PTT Station บจก.มีโชคปิโตรเลียม (19776)', province: 'นครศรีธรรมราช', region: 'ภาคใต้', usage: 8.8, client: 108, date: '2025-08-22', availability: 99.99 },
            { name: '7-11 PTT Station บจก.สไมล์ปิโตรเลียม (19777)', province: 'นครศรีธรรมราช', region: 'ภาคใต้', usage: 8.76, client: 107, date: '2025-08-23', availability: 99.95 },
            { name: '7-11 PTT Station ปตท.บจก.เบญจวรรณบริการ (20024)', province: 'บุรีรัมย์', region: 'ภาคตะวันออกเฉียงเหนือ', usage: 8.7, client: 123, date: '2025-08-24', availability: 99.99 },
            { name: '7-11 PTT Station ปตท.บจก.พี.พี.ดี.ปิโตรเลียม (20017)', province: 'นครราชสีมา', region: 'ภาคตะวันออกเฉียงเหนือ', usage: 8.64, client: 110, date: '2025-08-25', availability: 99.99 }
        ].filter(b => b.province !== '#VALUE!' && b.region !== '#VALUE!');


        // ---------------------------
        // END DATA SECTION
        // ---------------------------

        // --- Data Aggregation and Sorting ---
        // Fault Zones for Chart
        const faultZones = faultZoneData.map(d => d.zone);
        const faultData = faultZoneData.map(d => d.faults);

        // Availability Data
        const availabilityRawData = allBranchesData.map(d => ({ date: d.date, percent: d.availability }));
        availabilityRawData.sort((a, b) => new Date(a.date) - new Date(b.date));
        const daysInMonth = availabilityRawData.map(d => new Date(d.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }));
        const availabilityData = availabilityRawData.map(d => d.percent > 100 ? 100 : d.percent); // Cap data at 100
        const avgAvailability = availabilityData.length > 0 ? (availabilityData.reduce((a, b) => a + b, 0) / availabilityData.length).toFixed(2) : "0.00";
        document.getElementById('avgAvailability').textContent = `${avgAvailability}%`;

        // Top 20 Usage
        const sortedByUsage = [...allBranchesData].sort((a, b) => b.usage - a.usage).slice(0, 20);
        const top20UsageData = {
            labels: sortedByUsage.map(b => b.name),
            data: sortedByUsage.map(b => b.usage)
        };
        // Top 20 Clients
        const sortedByClient = [...allBranchesData].sort((a, b) => b.client - a.client).slice(0, 20);
        const top20ClientData = {
            labels: sortedByClient.map(b => b.name),
            data: sortedByClient.map(b => b.client)
        };
        // Region Summary
        const regionSummary = allBranchesData.reduce((acc, branch) => {
            const region = branch.region;
            if (region) {
                if (!acc[region]) {
                    acc[region] = { client: 0, usage: 0 };
                }
                acc[region].client += branch.client;
                acc[region].usage += branch.usage;
            }
            return acc;
        }, {});
        // Province Summary
        const provinceSummary = allBranchesData.reduce((acc, branch) => {
            const province = branch.province;
            if (province) {
                if (!acc[province]) {
                    acc[province] = { client: 0, usage: 0 };
                }
                acc[province].client += branch.client;
                acc[province].usage += branch.usage;
            }
            return acc;
        }, {});
        
        // --- Chart Rendering ---
        const availabilityCtx = document.getElementById('availabilityChart').getContext('2d');
        new Chart(availabilityCtx, {
            type: 'line',
            data: {
                labels: daysInMonth,
                datasets: [{
                    label: 'Availability (%)',
                    data: availabilityData,
                    borderColor: secondaryBorderColor,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.3,
                    pointBackgroundColor: secondaryBorderColor
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: 'Availability (%)' } }
                }
            }
        });

        const faultZoneCtx = document.getElementById('faultZoneChart').getContext('2d');
        new Chart(faultZoneCtx, {
            type: 'doughnut',
            data: {
                labels: faultZones,
                datasets: [{
                    label: 'จำนวน Faults',
                    data: faultData,
                    backgroundColor: professionalColors,
                    hoverOffset: 4,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        const topUsageCtx = document.getElementById('topUsageChart').getContext('2d');
        new Chart(topUsageCtx, {
            type: 'bar',
            data: {
                labels: top20UsageData.labels,
                datasets: [{
                    label: 'Usage (GB)',
                    data: top20UsageData.data,
                    backgroundColor: primaryColor,
                    borderColor: primaryBorderColor,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'Usage (GB)' }
                    }
                }
            }
        });

        const topUsersCtx = document.getElementById('topUsersChart').getContext('2d');
        new Chart(topUsersCtx, {
            type: 'bar',
            data: {
                labels: top20ClientData.labels,
                datasets: [{
                    label: 'จำนวน Client',
                    data: top20ClientData.data,
                    backgroundColor: secondaryColor,
                    borderColor: secondaryBorderColor,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        beginAtZero: true,
                        title: { display: true, text: 'จำนวน Client' }
                    }
                }
            }
        });

        const regionClientCtx = document.getElementById('regionClientChart').getContext('2d');
        const regionLabels = Object.keys(regionSummary);
        const regionClientData = regionLabels.map(region => regionSummary[region].client);
        new Chart(regionClientCtx, {
            type: 'pie',
            data: {
                labels: regionLabels,
                datasets: [{
                    label: 'จำนวน Client',
                    data: regionClientData,
                    backgroundColor: professionalColors,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        const provinceUsageCtx = document.getElementById('provinceUsageChart').getContext('2d');
        const sortedProvinces = Object.entries(provinceSummary).sort(([,a],[,b]) => b.usage - a.usage).slice(0, 10);
        const provinceLabels = sortedProvinces.map(p => p[0]);
        const provinceUsageData = sortedProvinces.map(p => p[1].usage.toFixed(2));
        new Chart(provinceUsageCtx, {
            type: 'bar',
            data: {
                labels: provinceLabels,
                datasets: [{
                    label: 'Usage (GB)',
                    data: provinceUsageData,
                    backgroundColor: accentColor,
                    borderColor: accentBorderColor,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, title: { display: true, text: 'Usage (GB)' } } }
            }
        });

        const provinceClientCtx = document.getElementById('provinceClientChart').getContext('2d');
        const sortedProvincesByClient = Object.entries(provinceSummary).sort(([,a],[,b]) => b.client - a.client);
        const top7Provinces = sortedProvincesByClient.slice(0, 7);
        const otherProvincesClient = sortedProvincesByClient.slice(7).reduce((sum, current) => sum + current[1].client, 0);
        const provinceClientLabels = top7Provinces.map(p => p[0]);
        const provinceClientData = top7Provinces.map(p => p[1].client);
        if (otherProvincesClient > 0) {
            provinceClientLabels.push('อื่น ๆ');
            provinceClientData.push(otherProvincesClient);
        }
        new Chart(provinceClientCtx, {
            type: 'pie',
            data: {
                labels: provinceClientLabels,
                datasets: [{
                    label: 'จำนวน Client',
                    data: provinceClientData,
                    backgroundColor: professionalColors,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        const regionUsageCtx = document.getElementById('regionUsageChart').getContext('2d');
        const sortedRegionsByUsage = Object.entries(regionSummary).sort(([,a],[,b]) => b.usage - a.usage);
        const regionUsageLabels = sortedRegionsByUsage.map(r => r[0]);
        const regionUsageData = sortedRegionsByUsage.map(r => r[1].usage.toFixed(2));
        new Chart(regionUsageCtx, {
            type: 'bar',
            data: {
                labels: regionUsageLabels,
                datasets: [{
                    label: 'Usage (GB)',
                    data: regionUsageData,
                    backgroundColor: primaryColor,
                    borderColor: primaryBorderColor,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { beginAtZero: true, title: { display: true, text: 'Usage (GB)' } } }
            }
        });

        // --- New Chart: Lowest Availability ---
        const lowestAvailabilityCtx = document.getElementById('lowestAvailabilityChart').getContext('2d');
        const sortedByLowestAvailability = [...allBranchesData]
            .sort((a, b) => a.availability - b.availability) // Ascending sort
            .slice(0, 10);

        const lowestAvailabilityLabels = sortedByLowestAvailability.map(b => b.name);
        const lowestAvailabilityData = sortedByLowestAvailability.map(b => b.availability);

        new Chart(lowestAvailabilityCtx, {
            type: 'bar',
            data: {
                labels: lowestAvailabilityLabels,
                datasets: [{
                    label: 'Availability (%)',
                    data: lowestAvailabilityData,
                    backgroundColor: dangerColor,
                    borderColor: dangerBorderColor,
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        beginAtZero: false,
                        title: { display: true, text: 'Availability (%)' }
                    }
                }
            }
        });

    </script>
</body>
</html>
